name: Trigger Cosmos Health Check

on:
  workflow_call:
    inputs:
      city:
        description: 'City folder name for GitHub JSON files (default: charlotte)'
        required: false
        default: 'charlotte'
        type: string
  workflow_dispatch:
    inputs:
      city:
        description: 'City folder name for GitHub JSON files (default: charlotte)'
        required: false
        default: 'charlotte'
        type: string

concurrency: 
  group: cosmos-health-check
  cancel-in-progress: true

jobs:
  trigger-cosmos-health-check:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Invoke Health Check
        id: invoke_script
        shell: pwsh
        working-directory: ./scripts
        env:
          AZURE_FUNCTION_KEY: ${{ secrets.AZURE_FUNCTION_KEY }}
        run: |
          $city = "${{ inputs.city }}"
          if ([string]::IsNullOrWhiteSpace($city)) {
            $city = "charlotte"
          }
          
          $FunctionUrl = "https://third-places-data.azurewebsites.net/api/cosmos/health?city=$city"
          
          Write-Host "Using function URL: $FunctionUrl"
          
          $FunctionKey = "$Env:AZURE_FUNCTION_KEY"
          
          # Call the health check using the standard script and capture its output
          $scriptOutput = ./Invoke-AzureFunction.ps1 -FunctionUrl $FunctionUrl -FunctionKey $FunctionKey -Method GET -TimeoutSeconds 900 | Out-String
          $scriptExitCode = $LASTEXITCODE
          
          # Print the output so it appears in logs
          Write-Host $scriptOutput
          
          # Parse the JSON from the script output (it prints "Response Body:" followed by JSON)
          try {
            if ($scriptOutput -match "Response Body:\s*(\{[\s\S]*\})") {
              $jsonString = $Matches[1]
              $response = $jsonString | ConvertFrom-Json
              
              $status = $response.status
              $discrepancyCount = $response.summary.discrepancyCount.value
              $errorCount = $response.summary.errorCount.value
              $orphanedFileCount = $response.summary.orphanedFileCount.value
              
              # --- GENERATE GITHUB SUMMARY ---
              echo "## Cosmos DB Health Check Report" >> $env:GITHUB_STEP_SUMMARY
              echo "" >> $env:GITHUB_STEP_SUMMARY
              
              # Status section
              if ($status -eq "healthy") {
                echo "### ✅ Status: Healthy" >> $env:GITHUB_STEP_SUMMARY
                echo "All systems are in sync. No action required." >> $env:GITHUB_STEP_SUMMARY
              } elseif ($status -eq "healthy_with_warnings") {
                echo "### ⚠️ Status: Healthy with Warnings" >> $env:GITHUB_STEP_SUMMARY
                echo "Systems are operational but have data inconsistencies that should be addressed." >> $env:GITHUB_STEP_SUMMARY
              } else {
                echo "### ❌ Status: Degraded" >> $env:GITHUB_STEP_SUMMARY
                echo "One or more data sources could not be reached. Check errors below." >> $env:GITHUB_STEP_SUMMARY
              }
              
              echo "" >> $env:GITHUB_STEP_SUMMARY
              echo "### Data Source Counts" >> $env:GITHUB_STEP_SUMMARY
              echo "" >> $env:GITHUB_STEP_SUMMARY
              echo "| Metric | Value | Description |" >> $env:GITHUB_STEP_SUMMARY
              echo "|--------|-------|-------------|" >> $env:GITHUB_STEP_SUMMARY
              echo "| **Cosmos Places** | $($response.summary.cosmosPlaces.value) | Place documents in Cosmos DB (synced from Airtable) |" >> $env:GITHUB_STEP_SUMMARY
              echo "| **Cosmos Chunks** | $($response.summary.cosmosChunks.value) | Text chunks for RAG/vector search (~140 per place) |" >> $env:GITHUB_STEP_SUMMARY
              echo "| **Airtable Syncable** | $($response.summary.airtableSyncableRecords.value) | Records with Google Maps Place Id (can sync to Cosmos) |" >> $env:GITHUB_STEP_SUMMARY
              echo "| **Airtable Total** | $($response.summary.airtableTotalRecords.value) | All records in Production view |" >> $env:GITHUB_STEP_SUMMARY
              echo "| **GitHub JSON Files** | $($response.summary.githubFiles.value) | Enriched data files (reviews, photos, metadata) |" >> $env:GITHUB_STEP_SUMMARY
              
              echo "" >> $env:GITHUB_STEP_SUMMARY
              echo "### Health Indicators" >> $env:GITHUB_STEP_SUMMARY
              echo "" >> $env:GITHUB_STEP_SUMMARY
              echo "| Indicator | Count | Notes |" >> $env:GITHUB_STEP_SUMMARY
              echo "|-----------|-------|-------|" >> $env:GITHUB_STEP_SUMMARY
              echo "| Errors | $errorCount | Data source connectivity issues |" >> $env:GITHUB_STEP_SUMMARY
              echo "| Discrepancies | $discrepancyCount | Data sync issues needing attention |" >> $env:GITHUB_STEP_SUMMARY
              echo "| Orphaned Files | $orphanedFileCount | JSON files from deleted places (informational) |" >> $env:GITHUB_STEP_SUMMARY
              
              # Add missing places section if there's a cosmos_vs_airtable discrepancy with details
              $cosmosDiscrepancy = $response.discrepancies | Where-Object { $_.type -eq "cosmos_vs_airtable" }
              if ($cosmosDiscrepancy -and $cosmosDiscrepancy.missingFromCosmos) {
                $missingCount = $cosmosDiscrepancy.missingFromCosmos.Count
                echo "" >> $env:GITHUB_STEP_SUMMARY
                echo "### ⚠️ Places Missing from Cosmos DB ($missingCount)" >> $env:GITHUB_STEP_SUMMARY
                echo "" >> $env:GITHUB_STEP_SUMMARY
                echo "These places exist in Airtable but have not been synced to Cosmos DB:" >> $env:GITHUB_STEP_SUMMARY
                echo "" >> $env:GITHUB_STEP_SUMMARY
                echo "| Place Name | Place ID |" >> $env:GITHUB_STEP_SUMMARY
                echo "|------------|----------|" >> $env:GITHUB_STEP_SUMMARY
                foreach ($place in $cosmosDiscrepancy.missingFromCosmos) {
                  # Escape pipe characters in place name to prevent Markdown table breakage
                  $escapedName = $place.placeName -replace '\|', '\|'
                  echo "| $escapedName | $($place.placeId) |" >> $env:GITHUB_STEP_SUMMARY
                }
                echo "" >> $env:GITHUB_STEP_SUMMARY
                echo "**Action:** Run ``cosmos/sync-places`` to sync these places." >> $env:GITHUB_STEP_SUMMARY
              }
              
              # Add orphaned files list if any exist
              if ($orphanedFileCount -gt 0) {
                echo "" >> $env:GITHUB_STEP_SUMMARY
                echo "### Orphaned JSON Files ($orphanedFileCount files)" >> $env:GITHUB_STEP_SUMMARY
                echo "" >> $env:GITHUB_STEP_SUMMARY
                echo "These files exist in GitHub but the corresponding place was deleted from Airtable. This is not an error - the files are simply no longer used during sync." >> $env:GITHUB_STEP_SUMMARY
                echo "" >> $env:GITHUB_STEP_SUMMARY
                echo "| Filename | Place Name |" >> $env:GITHUB_STEP_SUMMARY
                echo "|----------|------------|" >> $env:GITHUB_STEP_SUMMARY
                foreach ($file in $response.orphanedFiles.files) {
                  echo "| $($file.filename) | $($file.placeName) |" >> $env:GITHUB_STEP_SUMMARY
                }
              }
              
              # Add explanation
              echo "" >> $env:GITHUB_STEP_SUMMARY
              echo "### Understanding the Numbers" >> $env:GITHUB_STEP_SUMMARY
              echo "" >> $env:GITHUB_STEP_SUMMARY
              echo "- **Cosmos Places should equal Airtable Syncable** - Only records with a Google Maps Place Id can sync to Cosmos" >> $env:GITHUB_STEP_SUMMARY
              echo "- **Errors** mean a data source couldn't be reached" >> $env:GITHUB_STEP_SUMMARY
              echo "- **Discrepancies** mean data is out of sync and needs attention" >> $env:GITHUB_STEP_SUMMARY
              echo "- **Orphaned Files** are JSON files in GitHub for places that were deleted from Airtable. This is normal and not an issue." >> $env:GITHUB_STEP_SUMMARY
              
              Write-Host "Summary generated successfully."
            }
            else {
              Write-Warning "Could not find JSON output in script response"
              echo "## Cosmos DB Health Check Report" >> $env:GITHUB_STEP_SUMMARY
              echo "" >> $env:GITHUB_STEP_SUMMARY
              echo "Summary generation failed - could not parse script output." >> $env:GITHUB_STEP_SUMMARY
            }
          }
          catch {
            Write-Warning "Failed to generate summary: $_"
            echo "## Cosmos DB Health Check Report" >> $env:GITHUB_STEP_SUMMARY
            echo "" >> $env:GITHUB_STEP_SUMMARY
            echo "Summary generation failed. Check the workflow logs for details." >> $env:GITHUB_STEP_SUMMARY
          }
          
          # Exit with the original script's exit code
          if ($scriptExitCode -ne 0) {
            Write-Error "Health check failed."
            exit $scriptExitCode
          } else {
            Write-Host "Health check completed successfully." -ForegroundColor Green
          }

      - name: Check Script Result
        if: always()
        run: |
          echo "Script execution completed with status: ${{ steps.invoke_script.outcome }}"
          if ("${{ steps.invoke_script.outcome }}" -ne "success") {
            exit 1
          }
